<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:TReader.ViewModels"
        mc:Ignorable="d" d:DesignWidth="360" d:DesignHeight="400"
        x:Class="TReader.Views.ControlPanelWindow"
        x:DataType="vm:ControlPanelViewModel"
        Title="TReader"
        Width="360"
        Height="400"
        CanResize="False"
        WindowStartupLocation="CenterScreen"
        ExtendClientAreaToDecorationsHint="True"
        ExtendClientAreaChromeHints="NoChrome"
        ExtendClientAreaTitleBarHeightHint="-1"
        Background="Transparent"
        TransparencyLevelHint="AcrylicBlur">

    <Window.Styles>
        <!-- æ»šåŠ¨æ¡æžç®€æ ·å¼ -->
        <Style Selector="ScrollViewer">
            <Setter Property="AllowAutoHide" Value="True"/>
        </Style>
        
        <!-- åˆ—è¡¨é¡¹æ ·å¼é‡å†™ï¼šæžç®€è¡Œé£Žæ ¼ -->
        <Style Selector="ListBoxItem">
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="0,0,0,4"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Template">
                <ControlTemplate>
                    <Border Name="PART_Border" 
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            CornerRadius="{TemplateBinding CornerRadius}"
                            Padding="12,10">
                        <ContentPresenter Content="{TemplateBinding Content}" 
                                          ContentTemplate="{TemplateBinding ContentTemplate}"/>
                        <Border.Transitions>
                            <Transitions>
                                <BrushTransition Property="Background" Duration="0:0:0.2"/>
                            </Transitions>
                        </Border.Transitions>
                    </Border>
                </ControlTemplate>
            </Setter>
        </Style>
        
        <Style Selector="ListBoxItem:pointerover /template/ Border#PART_Border">
            <Setter Property="Background" Value="#252525"/>
        </Style>
        
        <Style Selector="ListBoxItem:selected /template/ Border#PART_Border">
            <Setter Property="Background" Value="#303030"/>
            <Setter Property="BorderBrush" Value="#27ae60"/>
            <Setter Property="BorderThickness" Value="2,0,0,0"/> <!-- å·¦ä¾§é«˜äº®æ¡ -->
        </Style>

        <!-- é€šç”¨æŒ‰é’®æ‚¬åœæ•ˆæžœ -->
        <Style Selector="Button.IconBtn:pointerover ContentPresenter">
            <Setter Property="Background" Value="#333"/>
        </Style>
    </Window.Styles>

    <Border Background="#101010" CornerRadius="8" ClipToBounds="True" BorderBrush="#333" BorderThickness="1">
        <Grid RowDefinitions="32,*">
            
            <!-- 1. æžç®€æ ‡é¢˜æ  -->
            <Grid Grid.Row="0" Background="#161616" ColumnDefinitions="Auto,*,Auto" PointerPressed="OnTitleBarPointerPressed">
                <StackPanel Orientation="Horizontal" Spacing="8" Margin="10,0" VerticalAlignment="Center">
                    <Border Width="3" Height="12" Background="#27ae60" CornerRadius="2"/> <!-- Logo Accent -->
                    <TextBlock Text="TReader" FontWeight="SemiBold" Foreground="#CCC" FontSize="12" VerticalAlignment="Center"/>
                </StackPanel>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button Click="OnMinimizeClick" Background="Transparent" Width="36" Height="32" CornerRadius="0">
                        <TextBlock Text="â”€" Foreground="#888" FontSize="12" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Button>
                    <Button Click="OnCloseClick" Background="Transparent" Width="36" Height="32" CornerRadius="0">
                        <TextBlock Text="âœ•" Foreground="#888" FontSize="12" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        <Button.Styles>
                            <Style Selector="Button:pointerover /template/ ContentPresenter">
                                <Setter Property="Background" Value="#C42B1C"/>
                            </Style>
                            <Style Selector="Button:pointerover TextBlock">
                                <Setter Property="Foreground" Value="White"/>
                            </Style>
                        </Button.Styles>
                    </Button>
                </StackPanel>
            </Grid>

            <!-- 2. ä¸»ä½“å¸ƒå±€ï¼šä¾§è¾¹æ  + å†…å®¹ -->
            <Grid Grid.Row="1" ColumnDefinitions="48,*">
                
                <!-- ä¾§è¾¹å¯¼èˆªæ  (Slim) -->
                <Border Grid.Column="0" Background="#161616">
                    <StackPanel Spacing="8" Margin="0,10">
                        <!-- ä¹¦æž¶ Tab -->
                        <Button Command="{Binding SwitchToShelfCommand}"
                                Classes="IconBtn"
                                Padding="0"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                HorizontalContentAlignment="Center"
                                VerticalContentAlignment="Center"
                                Background="Transparent" Height="40" Width="40" CornerRadius="6"
                                ToolTip.Tip="ä¹¦æž¶">
                            <TextBlock Text="ðŸ“š" FontSize="18" 
                                       Opacity="{Binding !IsSettingsMode, Converter={x:Static ObjectConverters.IsNull}}"/>
                        </Button>
                        <!-- è®¾ç½® Tab -->
                        <Button Command="{Binding SwitchToSettingsCommand}"
                                Classes="IconBtn"
                                Padding="0"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                HorizontalContentAlignment="Center"
                                VerticalContentAlignment="Center"
                                Background="Transparent" Height="40" Width="40" CornerRadius="6"
                                ToolTip.Tip="è®¾ç½®">
                            <TextBlock Text="âš™ï¸" FontSize="18" 
                                       Opacity="{Binding IsSettingsMode, Converter={x:Static ObjectConverters.IsNull}}"/>
                        </Button>
                        <!-- æ•™ç¨‹ Tab -->
                        <Button Command="{Binding SwitchToTutorialCommand}"
                                Classes="IconBtn"
                                Padding="0"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                HorizontalContentAlignment="Center"
                                VerticalContentAlignment="Center"
                                Background="Transparent" Height="40" Width="40" CornerRadius="6"
                                ToolTip.Tip="æ•™ç¨‹">
                            <TextBlock Text="ðŸ“–" FontSize="18" 
                                       Opacity="{Binding IsTutorialMode, Converter={x:Static ObjectConverters.IsNull}}"/>
                        </Button>
                    </StackPanel>
                </Border>

                <!-- å†…å®¹åŒºåŸŸ -->
                <Panel Grid.Column="1">
                    
                    <!-- View A: ä¹¦æž¶ (ç®€çº¦åˆ—è¡¨) -->
                    <Grid RowDefinitions="Auto,*,Auto" Margin="16,16,16,0" IsVisible="{Binding !IsSettingsMode}">
                        <Grid.IsVisible>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="!IsSettingsMode"/>
                                <Binding Path="!IsTutorialMode"/>
                            </MultiBinding>
                        </Grid.IsVisible>
                        <!-- Header -->
                        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,10">
                            <TextBlock Text="æˆ‘çš„ä¹¦åº“" FontSize="16" FontWeight="Bold" Foreground="#EEE"/>
                            <Button Grid.Column="1" Command="{Binding ImportBookCommand}"
                                    Background="Transparent" BorderBrush="#333" BorderThickness="1" 
                                    CornerRadius="4" Padding="8,4" Foreground="#27ae60">
                                <StackPanel Orientation="Horizontal" Spacing="4">
                                    <TextBlock Text="+" FontWeight="Bold"/>
                                    <TextBlock Text="å¯¼å…¥"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <!-- List -->
                        <ListBox Grid.Row="1" 
                                 ItemsSource="{Binding Books}" 
                                 SelectedItem="{Binding SelectedBook}"
                                 Background="Transparent"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto,*">
                                        <!-- ä¹¦ç±å›¾æ ‡ (å°) -->
                                        <Border Grid.Column="0" Width="24" Height="32" Background="#222" CornerRadius="2" Margin="0,0,12,0">
                                            <TextBlock Text="ðŸ“–" FontSize="12" HorizontalAlignment="Center" VerticalAlignment="Center" Opacity="0.5"/>
                                        </Border>
                                        <!-- ä¹¦å -->
                                        <TextBlock Grid.Column="1" Text="{Binding Title}" Foreground="#DDD" FontSize="13" 
                                                   VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                        
                        <!-- åº•éƒ¨æ“ä½œæ  (ä»…é€‰ä¸­æ—¶æ˜¾ç¤º) -->
                        <Border Grid.Row="2" Margin="-16,10,-16,0" Padding="16" Background="#1A1A1A" 
                                IsVisible="{Binding SelectedBook, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <Grid ColumnDefinitions="*,*">
                                <Button Grid.Column="0" Command="{Binding DeleteBookCommand}" 
                                        Content="åˆ é™¤" Foreground="#666" Background="Transparent" 
                                        HorizontalAlignment="Left" FontSize="12"/>
                                
                                <Button Grid.Column="1" Command="{Binding OpenBookCommand}" 
                                        Content="å¼€å§‹é˜…è¯»" Background="#27ae60" Foreground="White" 
                                        CornerRadius="4" HorizontalAlignment="Right" Padding="20,6" FontWeight="Bold"/>
                            </Grid>
                        </Border>
                    </Grid>

                    <!-- View B: è®¾ç½® (åž‚ç›´æµå¼å¸ƒå±€) -->
                    <Grid RowDefinitions="Auto,*,Auto" Margin="16,16,16,16" IsVisible="{Binding IsSettingsMode}">
                        <TextBlock Grid.Row="0" Text="åå¥½è®¾ç½®" FontSize="16" FontWeight="Bold" Foreground="#EEE" Margin="0,0,0,15"/>
                        
                        <ScrollViewer Grid.Row="1" Padding="0,0,4,0">
                            <StackPanel Spacing="20">
                                
                                <!-- Typography -->
                                <StackPanel Spacing="12">
                                    <TextBlock Text="æŽ’ç‰ˆ" FontSize="11" FontWeight="Bold" Foreground="#555"/>
                                    
                                    <!-- ç´§å‡‘çš„è®¾ç½®é¡¹ -->
                                    <Grid ColumnDefinitions="*,40" RowDefinitions="Auto,Auto">
                                        <TextBlock Text="å­—å·" Foreground="#AAA" FontSize="12"/>
                                        <TextBlock Grid.Column="1" Text="{Binding FontSize, StringFormat='{}{0:0}'}" Foreground="#27ae60" HorizontalAlignment="Right"/>
                                        <Slider Grid.Row="1" Grid.ColumnSpan="2" Value="{Binding FontSize}" Minimum="10" Maximum="30" Margin="0,4,0,0"/>
                                    </Grid>

                                    <Grid ColumnDefinitions="*,40" RowDefinitions="Auto,Auto">
                                        <TextBlock Text="è¡Œè·" Foreground="#AAA" FontSize="12"/>
                                        <TextBlock Grid.Column="1" Text="{Binding LineHeight, StringFormat='{}{0:0.0}'}" Foreground="#27ae60" HorizontalAlignment="Right"/>
                                        <Slider Grid.Row="1" Grid.ColumnSpan="2" Value="{Binding LineHeight}" Minimum="0.1" Maximum="2.5" TickFrequency="0.1" IsSnapToTickEnabled="True" Margin="0,4,0,0"/>
                                    </Grid>
                                    
                                    <Grid ColumnDefinitions="*,40" RowDefinitions="Auto,Auto">
                                        <TextBlock Text="æ®µè·" Foreground="#AAA" FontSize="12"/>
                                        <TextBlock Grid.Column="1" Text="{Binding ParagraphSpacing, StringFormat='{}{0:0.0}'}" Foreground="#27ae60" HorizontalAlignment="Right"/>
                                        <Slider Grid.Row="1" Grid.ColumnSpan="2" Value="{Binding ParagraphSpacing}" Minimum="0" Maximum="3" TickFrequency="0.1" IsSnapToTickEnabled="True" Margin="0,4,0,0"/>
                                    </Grid>
                                    
                                    <StackPanel Spacing="6">
                                        <TextBlock Text="å­—ä½“" Foreground="#AAA" FontSize="12"/>
                                        <ComboBox ItemsSource="{Binding AvailableFonts}" SelectedItem="{Binding FontFamily}" 
                                                  HorizontalAlignment="Stretch" Background="#1E1E1E" BorderThickness="0" CornerRadius="4" PlaceholderText="Default"/>
                                    </StackPanel>
                                </StackPanel>

                                <!-- Appearance -->
                                <StackPanel Spacing="12">
                                    <TextBlock Text="å¤–è§‚" FontSize="11" FontWeight="Bold" Foreground="#555"/>
                                    
                                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto">
                                        <TextBlock Grid.Column="0" Text="æ–‡å­—é¢œè‰²" Foreground="#AAA" FontSize="12" Margin="0,0,0,6"/>
                                        <ColorPicker Grid.Row="1" Grid.Column="0" Color="{Binding ForegroundColor}" />
                                        
                                        <TextBlock Grid.Column="1" Text="èƒŒæ™¯é¢œè‰²" Foreground="#AAA" FontSize="12" Margin="10,0,0,6"/>
                                        <ColorPicker Grid.Row="1" Grid.Column="1" Color="{Binding BackgroundColor}" Margin="10,0,0,0"/>
                                    </Grid>
                                </StackPanel>

                            </StackPanel>
                        </ScrollViewer>

                        <!-- Actions -->
                        <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto" Margin="0,10,0,0">
                             <Button Grid.Column="0" Command="{Binding CancelSettingsCommand}" 
                                     Content="å–æ¶ˆ" Background="Transparent" Foreground="#666" HorizontalAlignment="Left"/>
                             <Button Grid.Column="1" Command="{Binding ResetToDefaultCommand}" 
                                     Content="æ¢å¤é»˜è®¤" Background="Transparent" Foreground="#e74c3c" HorizontalAlignment="Center"/>
                             <Button Grid.Column="2" Command="{Binding SaveSettingsCommand}" 
                                     Content="ä¿å­˜" Background="#27ae60" Foreground="White" FontWeight="Bold" 
                                     CornerRadius="4" HorizontalAlignment="Right" Padding="20,6"/>
                        </Grid>
                    </Grid>
                    
                    <!-- View C: æ•™ç¨‹ -->
                    <Grid RowDefinitions="Auto,*" Margin="16,16,16,16" IsVisible="{Binding IsTutorialMode}">
                        <TextBlock Grid.Row="0" Text="ä½¿ç”¨æ•™ç¨‹" FontSize="16" FontWeight="Bold" Foreground="#EEE" Margin="0,0,0,15"/>
                        
                        <ScrollViewer Grid.Row="1" Padding="0,0,4,0">
                            <StackPanel Spacing="12">
                                <!-- åœ¨è¿™é‡Œæ·»åŠ æ•™ç¨‹å†…å®¹ -->
                                <TextBlock Text="1.æ‰˜ç›˜å†…å³å‡»å›¾æ ‡æ‰“å¼€æŽ§åˆ¶é¢æ¿" Foreground="white" FontSize="13" TextWrapping="Wrap"/>
                                <TextBlock Text="2.ç‚¹å‡»å¼€å§‹é˜…è¯»åŽï¼Œè¿›å…¥é˜…è¯»çª—å£" Foreground="white" FontSize="13" TextWrapping="Wrap"/>
                                <TextBlock Text="3.é¼ æ ‡ç§»åˆ°é˜…è¯»çª—å£ä¹‹å¤–ï¼Œé˜…è¯»ç•Œé¢ä¼šè‡ªåŠ¨éšè—" Foreground="white" FontSize="13" TextWrapping="Wrap"/>
                                <TextBlock Text="4.å½“ç„¦ç‚¹ç§»åˆ°å…¶ä»–åœ°æ–¹åŽï¼Œé˜…è¯»çª—å£ä¼šå½»åº•éšè—ï¼Œè¦æƒ³é‡æ–°æ˜¾ç¤ºï¼Œéœ€è¦æŒ‰ä½ctrlï¼Œç„¶åŽåŒå‡»é˜…è¯»ç•Œé¢æ‰€åœ¨åŒºåŸŸï¼Œå³å¯é‡æ–°æ˜¾ç¤ºé˜…è¯»çª—å£" Foreground="white" FontSize="13" TextWrapping="Wrap"/>
                                <TextBlock Text="5.å¦‚æžœæ‰¾ä¸åˆ°é˜…è¯»ç•Œé¢åœ¨å“ªäº†ï¼Œå³é”®æ‰˜ç›˜å›¾æ ‡ç‚¹å‡»åˆ·æ–°é˜…è¯»çª—å£ï¼Œå³å¯æŠŠé˜…è¯»çª—å£é‡æ–°æ˜¾ç¤ºåœ¨å±å¹•æ­£ä¸­å¤®" Foreground="white" FontSize="13" TextWrapping="Wrap"/>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>
                    
                    <!-- Loading Mask -->
                    <Border Grid.RowSpan="2" Grid.ColumnSpan="2" Background="#AA000000" IsVisible="{Binding IsLoading}" CornerRadius="8">
                         <ProgressBar IsIndeterminate="True" HorizontalAlignment="Center" VerticalAlignment="Center" Width="60"/>
                    </Border>
                </Panel>
            </Grid>
        </Grid>
    </Border>
</Window>